<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Friend Profile </title>
    <style>
      body {
        margin: 0;
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        background-color: #f9f9f9;
        color: #333;
        padding: 1rem;
      }

      header {
        margin-bottom: 1rem;
      }

      .back-button {
        text-decoration: none;
        color: #0077ff;
        font-size: 1rem;
      }

      .profile-page {
        max-width: 600px;
        margin: 0 auto;
        text-align: center;
      }

      .avatar-large {
        width: 96px;
        height: 96px;
        border-radius: 50%;
        object-fit: cover;
        margin-bottom: 0.75rem;
        box-shadow: 0 2px 6px rgba(0,0,0,0.1);
      }

      .profile-name {
        font-size: 1.5rem;
        font-weight: 600;
        margin-bottom: 0.5rem;
      }

      .tags {
        display: flex;
        flex-wrap: wrap;
        justify-content: center;
        gap: 0.5rem;
        margin-bottom: 1rem;
      }

      .tag {
        background: #e0f0ff;
        color: #0077ff;
        padding: 0.3rem 0.6rem;
        border-radius: 999px;
        font-size: 0.85rem;
      }

      .meta {
        font-size: 1rem;
        margin: 0.25rem 0;
      }

      .notes {
        margin-top: 1.5rem;
        text-align: left;
      }

      .notes h2 {
        font-size: 1.2rem;
        margin-bottom: 0.5rem;
        text-align: center;
      }

      .notes ul {
        padding-left: 1.2rem;
      }

      .notes li {
        margin-bottom: 0.5rem;
      }

      .note-edit-area {
        width: 100%;
        height: 120px;
        padding: 0.75rem;
        font-size: 1rem;
        border: 1px solid #ccc;
        border-radius: 6px;
        box-sizing: border-box;
        margin-top: 0.5rem;
      }

      .edit-controls {
        margin-top: 0.75rem;
        display: flex;
        gap: 0.5rem;
        justify-content: center;
      }

      .edit-controls button {
        padding: 0.6rem 1rem;
        font-size: 0.95rem;
        border: none;
        border-radius: 6px;
        cursor: pointer;
      }

      .edit-controls .save {
        background-color: #0077ff;
        color: white;
      }

      .edit-controls .cancel {
        background-color: #ccc;
      }

      .profile-actions {
        display: flex;
        flex-direction: column;
        gap: 0.75rem;
        margin-top: 2rem;
      }

      .profile-actions button {
        padding: 0.75rem;
        font-size: 1rem;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        background-color: #0077ff;
        color: white;
        transition: background 0.2s ease;
      }

      .profile-actions button:hover {
        background-color: #005fcc;
      }

      .profile-actions .danger {
        background-color: #ff4d4f;
      }

      .profile-actions .danger:hover {
        background-color: #d9363a;
      }

      .interactions {
        margin-top: 1.5rem;
        text-align: left;
      }

      .interactions h2 {
        font-size: 1.2rem;
        margin-bottom: 0.5rem;
        text-align: center;
      }

      .interaction-list {
        list-style: none;
        padding: 0;
        margin: 0;
      }

      .interaction-item {
        background: white;
        border-radius: 8px;
        padding: 0.75rem 1rem;
        margin-bottom: 0.75rem;
        box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        cursor: pointer;
        transition: background 0.2s ease;
      }

      .interaction-item:hover {
        background: #f0f8ff;
      }

      .interaction-date {
        font-weight: 600;
        font-size: 0.95rem;
        color: #0077ff;
      }

      .interaction-summary {
        margin-top: 0.5rem;
        font-size: 0.9rem;
        color: #444;
        display: none; /* hidden until clicked */
      }

      .profile-img-wrapper {
        position: relative;
        display: inline-block;
      }

      .avatar-large {
        width: 120px;
        height: 120px;
        border-radius: 50%;
        object-fit: cover;
      }

      .edit-img-btn {
        position: absolute;
        bottom: 8px;
        right: 8px;
        background-color: #333;
        color: white;
        border: none;
        border-radius: 50%;
        padding: 6px;
        cursor: pointer;
        display: none; /* Hidden by default */
      }

      .edit-img-btn:hover {
        background-color: #007bff;
      }

      .profile-name, .funFactTV, #funFactTV  {
        padding: 6px;
        border-radius: 6px;
        transition: all 0.3s;
      }

      .editable {
        background-color: #eef6ff;
        border: 1px dashed #007bff;
        outline: none;
      }

      .profile-name:focus,
      .funFactTV:focus , #funFactTV:focus {
        background-color: #dcefff;
        border: 1px solid #007bff;
      }
    </style>
  </head>
  <body>
    <header>
      <a href="mainView.html" id="backBtn" style="display: inline;"  class="back-button">‚Üê Back</a>
      <div id="editBar" style="display: none; justify-content: space-between; width: 100%;">
        <a href="mainView.html" id="cancelBtn" style="color: #333;" class="back-button">Cancel</a>
        <a href="mainView.html" id="saveBtn" class="back-button">Save</a>
      </div>
    </header>

    <main class="profile-page">
      <div class="profile-img-wrapper">
        <img id="userImg" alt="Mark Johnson" class="avatar-large" />
        <button id="editImgBtn" class="edit-img-btn">‚úèÔ∏è</button>
      </div>

      <div id="nameTV" class="profile-name"></div>

      <textarea  id="nameET" class="note-edit-area" style="width: 240px; height: 40px; resize: none; margin: 8px; display: none;"></textarea>

      <p id="funFactTV"></p>

      <textarea  id="funFactET" class="note-edit-area" style="width: 240px; height: 40px; resize: none; margin: 8px; display: none;"></textarea>

      <div id="clubDiv" class="tags"></div>

      <!--<p id="metTV" class="meta"><strong>üìÖ Last Met:</strong> 2 weeks ago</p>-->
      
      <div style="display: flex; justify-content: center; align-items: center; gap: 6px;">
        <strong>üìç Location </strong> 
        <span id="locationTV"></span> 
        <textarea  id="locationET" class="note-edit-area" style="width: 240px; height: 40px; display: none;  resize: none;"></textarea>
      </div>


      <div class="notes">
        <h2>üìù Notes</h2>

        <div id="notes-edit" style="display: none;">
          <textarea id="note-textarea" class="note-edit-area"></textarea>
          
        </div>

        <div id="notes-view">
          <ul id="note-list">
         
          </ul>
        </div>
        <div class="interactions">
          <h2>ü§ù Interactions</h2>
          <ul id="interaction-list" class="interaction-list">
          </ul>
        </div>

      </div>

      <div class="profile-actions">
        <button id="editBtn" onclick="editProfile()">‚úèÔ∏è Edit Profile</button>
        <button id="interactionBtn" onclick="addInteraction()">‚ûï Add Interaction</button>
        <button id="deleteBtn" onclick="deleteFriend()" class="danger">üóëÔ∏è Delete Friend</button>
      </div>
    </main>
    <script type="module">
      // Import the necessary Firebase SDK functions
      import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.0/firebase-app.js";
      import { getFirestore, doc, getDoc } from "https://www.gstatic.com/firebasejs/9.6.0/firebase-firestore.js";
      import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.6.0/firebase-auth.js"
   
      const firebaseConfig = {
          apiKey: "AIzaSyB_1iwdvhIPZ6wbtlFft_vvfRjASUb_XyY",
          authDomain: "win-friends-app.firebaseapp.com",
          projectId: "win-friends-app",
          storageBucket: "win-friends-app.firebasestorage.app",
          messagingSenderId: "1006457660053",
          appId: "1:1006457660053:web:b1b104becc2f590a21319c",
          measurementId: "G-0H4L7PK4L9"
      };

      const app = initializeApp(firebaseConfig);
      const db = getFirestore(app);
      const auth = getAuth(app)

      const notes = [
        "Talked about AI and chess",
        "Send him the chess link",
        "He‚Äôs starting a new role at work"
      ];

      const editBar = document.getElementById("editBar")
      const backBtn = document.getElementById("backBtn")
      const saveBtn = document.getElementById("saveBtn")
      const cancelBtn = document.getElementById("cancelBtn")

      const locationTV = document.getElementById("locationTV")
      const locationET = document.getElementById("locationET")

      const noteListEl = document.getElementById('note-list');
      const noteTextarea = document.getElementById('note-textarea');
      const notesView = document.getElementById('notes-view');
      const notesEdit = document.getElementById('notes-edit');

      const editBtn = document.getElementById("editBtn")
      const interactionBtn = document.getElementById("interactionBtn")
      const deleteBtn = document.getElementById("deleteBtn")

      editBtn.onclick = () => {
        editProfile()
        
      }

      cancelBtn.onclick = () => {
        cancelEdit()
      }

      interactionBtn.onclick = () => {
        addInteraction()
      }

      deleteBtn.onclick = () => {
        deleteFriend()
      }


      function editProfile() {
        // Show textarea with current notes
        editBar.style.display = 'flex'
        deleteBtn.style.display = 'none'

        locationET.style.display = "block"
        locationTV.style.display = "none"

        editBtn.style.display = 'none'
        interactionBtn.style.display = 'none'
        noteTextarea.value = notesView.innerText;
     
        notesView.style.display = 'none';
        notesEdit.style.display = 'block';
        backBtn.style.display = "none"
        editImgBtn.style.display = 'block';

        editBtn.style.display = 'none';
        saveBtn.style.display = 'inline-block';
        cancelBtn.style.display = 'inline-block';
      }

      function cancelEdit() {
        notesEdit.style.display = 'none';
        notesView.style.display = 'block';
      }

      function saveNotes() {
        const updatedText = noteTextarea.value.trim();
        const updatedNotes = updatedText.split('\n').filter(line => line.trim() !== '');
        notes.length = 0;
        notes.push(...updatedNotes);
        renderNotes();
        cancelEdit();
      }

      function uploadNotes()
      {
        
      }

      function renderNotes(notes) {
        noteListEl.innerHTML = '';
        notes.forEach(note => {
          const li = document.createElement('li');
          li.textContent = note;
          noteListEl.appendChild(li);
        });
      }

      function renderClubs(clubs) {
        //noteListEl.innerHTML = '';
        let clubDiv = document.getElementById("clubDiv")
        clubDiv.innerHTML = ''
        clubs.forEach(note => {
          const span = document.createElement('span');
          span.classList.add('tag');
          span.textContent = note;
          clubDiv.appendChild(span);
        });
      }

      function addInteraction() {
        window.location.href='add.html'
      }

      function deleteFriend() {
        if (confirm("Are you sure you want to delete this friend?")) {
          alert("Friend deleted.");
          // You could redirect or update state here
        }
      }

      // Initial render
      //renderNotes();

      async function getFriendInfo(currentUserId)
      {
        const params = new URLSearchParams(window.location.search);
        const userId = params.get('id');

        let friendRef = doc(db, `users/${currentUserId}/friends/${userId}`)

        const friendSnap = await getDoc(friendRef);

        if(!friendSnap.exists()){
          alert("error NP: 336")
        }else{
          let data = friendSnap.data()
          let name = data.name
          let phone = data.phone 
          let email = data.email
          let imageUrl = data.imageUrl
          if(imageUrl == null){
            imageUrl = "https://img.freepik.com/free-vector/blue-circle-with-white-user_78370-4707.jpg?semt=ais_hybrid&w=740&q=80"
          }
          let funFact = data.funFact
          let location = data.location 
          let notes =  data.notes 
          let group = data.group

          populateData(name, imageUrl, funFact, phone, email, group, location, notes)
        }
      }

      function populateData(name, imageUrl, funFact, phone, email, group, location, notes)
      {
          let funFactTV = document.getElementById("funFactTV")
          let nameTV = document.getElementById("nameTV")
          let userImg = document.getElementById("userImg")
          let locationTV = document.getElementById("locationTV")

          funFactTV.innerText = funFact
          nameTV.innerText = name 
          userImg.src = imageUrl
          locationTV.innerText =  `lat: ${location.latitude}  lon: ${location.longitude}`
          renderNotes(notes);
          renderClubs(group)
      }

      function setProfile(data){
          let nameTV = document.getElementById("nameTV")
          let noteList = document.getElementById("note-list")

          nameTV.innerText = data.name
          //have to just set name,
          //have to set notes chronologically 
      }

      const interactions = [
        {
          date: "2025-09-10",
          type: "Coffee Meetup ‚òï",
          summary: "Talked about his new role and upcoming project. Shared some tips on productivity apps."
        },
        {
          date: "2025-08-28",
          type: "Phone Call üìû",
          summary: "He mentioned traveling to New York soon. Discussed keeping in touch with the Chess Club."
        },
        {
          date: "2025-08-15",
          type: "Lunch üçΩÔ∏è",
          summary: "Caught up after 3 months. Talked about AI, work stress, and his chess strategies."
        }
      ];

      const interactionListEl = document.getElementById("interaction-list");

      function renderInteractions() {
        interactionListEl.innerHTML = '';
        interactions.forEach((interaction, index) => {
          const li = document.createElement("li");
          li.className = "interaction-item";
          li.innerHTML = `
            <div class="interaction-date">${interaction.date} ‚Äî ${interaction.type}</div>
            <div class="interaction-summary">${interaction.summary}</div>
          `;
          
          li.addEventListener("click", () => {
            const summaryEl = li.querySelector(".interaction-summary");
            const isVisible = summaryEl.style.display === "block";
            summaryEl.style.display = isVisible ? "none" : "block";
          });

          interactionListEl.appendChild(li);
        });
      }

      // Render when page loads
      renderInteractions();
      const editImgBtn = document.getElementById('editImgBtn');
      const userImg = document.getElementById('userImg');

      // When "Edit Profile" is clicked ‚Üí show the pencil
      /*editProfileBtn.addEventListener('click', () => {
        editImgBtn.style.display = 'block';
      });*/

      // When the pencil is clicked ‚Üí open file picker and change image
      editImgBtn.addEventListener('click', () => {
        const fileInput = document.createElement('input');
        fileInput.type = 'file';
        fileInput.accept = 'image/*';

        fileInput.onchange = (e) => {
          const file = e.target.files[0];
          if (file) {
            userImg.src = URL.createObjectURL(file);
          }
        };

        fileInput.click();
      });

      onAuthStateChanged(auth, (user) => 
      {
        if (!user) {
            window.location.href = "winFriends.html";
            return;
            //alert(`user not logged in still`)
        }
        else{
            getFriendInfo(user.uid)
        }
      });
    </script>
  </body>
</html>
